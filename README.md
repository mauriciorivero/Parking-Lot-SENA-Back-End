# Parking Management System API

Sistema de gesti√≥n de parqueaderos con arquitectura de microservicios desarrollado en Node.js, Express y MySQL con ORM manual.

## üèóÔ∏è Arquitectura

Este proyecto est√° estructurado siguiendo las mejores pr√°cticas de desarrollo de APIs REST con Express.js:

```
src/
‚îú‚îÄ‚îÄ app.js                 # Configuraci√≥n principal de Express con CORS mejorado
‚îú‚îÄ‚îÄ server.js              # Punto de entrada del servidor
‚îú‚îÄ‚îÄ config/                # Configuraciones
‚îÇ   ‚îú‚îÄ‚îÄ DatabaseConnection.js
‚îÇ   ‚îú‚îÄ‚îÄ checkDbConnection.js
‚îÇ   ‚îî‚îÄ‚îÄ environment.js
‚îú‚îÄ‚îÄ controllers/           # L√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ usuario.controller.js     # Sistema completo de usuarios + autenticaci√≥n MD5
‚îÇ   ‚îú‚îÄ‚îÄ vehiculo.controller.js    # Gesti√≥n mejorada de veh√≠culos
‚îÇ   ‚îú‚îÄ‚îÄ celda.controller.js       # Funcionalidades mejoradas
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ middlewares/          # Middleware personalizado
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js
‚îÇ   ‚îú‚îÄ‚îÄ notFound.js
‚îÇ   ‚îî‚îÄ‚îÄ asyncHandler.js
‚îú‚îÄ‚îÄ models/               # Modelos ORM manuales
‚îÇ   ‚îú‚îÄ‚îÄ Usuario.js               # Con encriptaci√≥n MD5, m√∫ltiples b√∫squedas y validateLogin
‚îÇ   ‚îú‚îÄ‚îÄ Vehiculo.js              # B√∫squedas mejoradas y validaciones de placa
‚îÇ   ‚îú‚îÄ‚îÄ Celda.js                 # Funciones corregidas y mejoradas
‚îÇ   ‚îú‚îÄ‚îÄ AccesoSalida.js          # Con c√°lculo autom√°tico de tiempo de estad√≠a
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ routes/               # Definici√≥n de rutas
‚îÇ   ‚îú‚îÄ‚îÄ usuario.routes.js        # 11 endpoints completos de usuarios
‚îÇ   ‚îú‚îÄ‚îÄ vehiculo.routes.js       # Gesti√≥n completa de veh√≠culos
‚îÇ   ‚îú‚îÄ‚îÄ celda.routes.js          # Endpoints debug y configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ accesoSalida.routes.js   # Con c√°lculo autom√°tico y estado de veh√≠culos
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ services/             # Servicios de negocio (futuro)
‚îú‚îÄ‚îÄ utils/                # Utilidades (futuro)
‚îî‚îÄ‚îÄ validators/           # Validadores (futuro)
```

## üöÄ Caracter√≠sticas Principales

- **API REST completa** con todos los m√©todos HTTP
- **Arquitectura de microservicios** lista para escalabilidad
- **ORM manual** con operaciones CRUD completas
- **üîê Autenticaci√≥n MD5** - Sistema seguro de login de usuarios
- **üåê CORS optimizado** - Acceso desde cualquier dominio/puerto (incluyendo localhost:5175, 5174)
- **üõ°Ô∏è Middleware de seguridad** (Helmet, CORS, Rate Limiting)
- **üìù Sistema de logging** - Para debugging y monitoreo
- **‚úÖ Validaciones robustas** - Para tipos y estados de celdas
- **üîß Endpoints de debug** - Para troubleshooting
- **üìä Configuraci√≥n din√°mica** - Obtener tipos y estados v√°lidos
- **üöó Gesti√≥n completa de celdas** - Crear, actualizar tipo/estado, eliminar
- **‚è±Ô∏è C√°lculo autom√°tico de tiempo de estad√≠a** - Para salidas de veh√≠culos
- **üö™ Control inteligente de accesos** - Validaciones entrada/salida
- **üìç Estado en tiempo real de veh√≠culos** - Consultar si est√° dentro/fuera
- **üîç B√∫squedas flexibles** - Por email, documento, identificador universal
- **üì± Compatible con frontends** - React, Vue, Angular en cualquier puerto
- **üìÑ Paginaci√≥n** en endpoints de listado
- **üè• Health checks** para monitoreo
- **‚òÅÔ∏è Configuraci√≥n para despliegue** en Vercel y Render

## üõ†Ô∏è Instalaci√≥n y Configuraci√≥n

### Prerrequisitos
- Node.js >= 18.0.0
- npm >= 8.0.0
- MySQL >= 5.7

### Pasos de instalaci√≥n

1. **Clonar el repositorio**
```bash
git clone https://github.com/mauriciorivero/ParkingSENABend.git
cd ParkingSENABend
```

2. **Instalar dependencias**
```bash
npm install
```

3. **Configurar variables de entorno**
```bash
# Copiar el archivo de ejemplo
cp env.example .env

# Editar las variables de entorno
nano .env
```

4. **Configurar la base de datos**
```bash
# Importar el script SQL
mysql -u root -p < Script-SQL-ParkingLot.sql
```

5. **Verificar conexi√≥n a la base de datos**
```bash
node src/config/checkDbConnection.js
```

6. **Iniciar el servidor**
```bash
# Desarrollo
npm run dev

# Producci√≥n
npm start
```

## üìã Documentaci√≥n Completa de API

### üîó **URL Base**: `http://localhost:3001`

---

## üîê **AUTENTICACI√ìN - ENDPOINT PRINCIPAL PARA FRONTEND**

### **‚≠ê POST** `/api/usuarios/login` - Login de usuario
**üéØ ENDPOINT CLAVE**: Este es el endpoint principal que el frontend debe usar para implementar el sistema de login.

#### **üìã Informaci√≥n T√©cnica:**
- **URL Completa**: `http://localhost:3001/api/usuarios/login`
- **M√©todo**: `POST`
- **Encriptaci√≥n**: MD5 autom√°tica
- **Validaci√≥n**: Email y contrase√±a requeridos

#### **üì§ Request (Petici√≥n):**

**Headers:**
```
Content-Type: application/json
```

**Body (JSON):**
```json
{
  "direccion_correo": "user@example.com",
  "clave": "mi_password_123"
}
```

#### **üì• Responses (Respuestas):**

**‚úÖ Login Exitoso (200):**
```json
{
  "success": true,
  "message": "Login exitoso",
  "data": {
    "id_usuario": 1,
    "tipo_documento": "cedula",
    "numero_documento": "12345678",
    "primer_nombre": "Juan",
    "segundo_nombre": "Carlos",
    "primer_apellido": "P√©rez",
    "segundo_apellido": "Gonz√°lez",
    "direccion_correo": "user@example.com",
    "numero_celular": "3001234567",
    "foto_perfil": "https://ejemplo.com/foto.jpg",
    "estado": "activo",
    "perfil_usuario_id": 3
    // üîí NOTA: El campo 'clave' NUNCA se retorna por seguridad
  }
}
```

**‚ùå Errores Posibles:**

```json
// Credenciales inv√°lidas (401)
{
  "success": false,
  "error": "Credenciales inv√°lidas"
}

// Datos faltantes (400)
{
  "success": false,
  "error": "Email y clave son requeridos"
}

// Error del servidor (500)
{
  "success": false,
  "error": "Error interno del servidor durante el login"
}
```

#### **üíª Implementaci√≥n en Frontend:**

**JavaScript/Fetch:**
```javascript
async function loginUser(email, password) {
  try {
    const response = await fetch('http://localhost:3001/api/usuarios/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        direccion_correo: email,
        clave: password
      })
    });

    const data = await response.json();
    
    if (data.success) {
      // Login exitoso - guardar datos del usuario
      localStorage.setItem('user', JSON.stringify(data.data));
      localStorage.setItem('isLoggedIn', 'true');
      return { success: true, user: data.data };
    } else {
      return { success: false, error: data.error };
    }
  } catch (error) {
    return { success: false, error: 'Error de conexi√≥n' };
  }
}

// Uso
const result = await loginUser('user@example.com', 'password123');
```

**React Example:**
```javascript
const [user, setUser] = useState(null);
const [error, setError] = useState('');

const handleLogin = async (email, password) => {
  const result = await loginUser(email, password);
  
  if (result.success) {
    setUser(result.user);
    setError('');
    // Redirigir al dashboard
  } else {
    setError(result.error);
  }
};
```

---

## üë• **USUARIOS** - `/api/usuarios` *(Sistema Completo - 11 Endpoints)*

### **üÜï GET** `/api/usuarios/config` - Obtener configuraci√≥n de usuarios
Endpoint para obtener todos los tipos de documento, estados v√°lidos, validaciones y documentaci√≥n completa.

**Ejemplo Postman:**
```
GET http://localhost:3001/api/usuarios/config
```

**Respuesta:**
```json
{
  "success": true,
  "data": {
    "tipos_documento": {
      "allowed": ["cedula", "tarjeta_identidad", "cedula_extranjeria", "pasaporte"],
      "descriptions": {
        "cedula": "C√©dula de Ciudadan√≠a",
        "tarjeta_identidad": "Tarjeta de Identidad",
        // ...
      }
    },
    "estados": {
      "allowed": ["activo", "inactivo", "suspendido", "bloqueado"],
      "descriptions": { /* descripciones de cada estado */ }
    },
    "campos": { /* validaciones completas de cada campo */ },
    "endpoints": { /* lista de todos los endpoints disponibles */ }
  }
}
```

### **GET** `/api/usuarios` - Obtener todos los usuarios
**Query Parameters (opcionales):**
- `page` (number): P√°gina (default: 1)
- `limit` (number): L√≠mite por p√°gina (default: 10)
- `estado` (string): Filtrar por estado
- `perfil_usuario_id` (number): Filtrar por perfil

**Ejemplo Postman:**
```
GET http://localhost:3001/api/usuarios?page=1&limit=5&estado=activo
```

### **GET** `/api/usuarios/:id` - Obtener usuario por ID

### **GET** `/api/usuarios/documento/:numero_documento` - Obtener usuario por documento

### **üÜï GET** `/api/usuarios/email/:email` - Obtener usuario por email
**Nuevo endpoint** para buscar usuarios espec√≠ficamente por su direcci√≥n de correo electr√≥nico.

**Ejemplo Postman:**
```
GET http://localhost:3001/api/usuarios/email/juan@ejemplo.com
```

**Respuesta:**
```json
{
  "success": true,
  "data": {
    "id_usuario": 1,
    "direccion_correo": "juan@ejemplo.com",
    "primer_nombre": "Juan",
    // ... otros campos del usuario
  }
}
```

### **üÜï GET** `/api/usuarios/buscar/:identifier` - B√∫squeda universal por identificador
**Endpoint inteligente** que busca por email O n√∫mero de documento autom√°ticamente.

**Ejemplo Postman:**
```
GET http://localhost:3001/api/usuarios/buscar/juan@ejemplo.com
GET http://localhost:3001/api/usuarios/buscar/12345678
```

**Respuesta:**
```json
{
  "success": true,
  "data": { /* datos del usuario */ },
  "info": {
    "tipo_busqueda": "email", // o "documento"
    "identificador_usado": "juan@ejemplo.com"
  }
}
```

### **POST** `/api/usuarios` - Crear nuevo usuario
**üí° Nota**: Las contrase√±as se encriptan autom√°ticamente con MD5.

**Body (JSON):**
```json
{
  "tipo_documento": "cedula",
  "numero_documento": "87654321",
  "primer_nombre": "Ana",
  "segundo_nombre": "Mar√≠a",
  "primer_apellido": "Garc√≠a",
  "segundo_apellido": "Rodr√≠guez",
  "direccion_correo": "ana.garcia@email.com",
  "numero_celular": "3009876543",
  "foto_perfil": "ana.jpg",
  "estado": "activo",
  "clave": "mi_password_123",
  "perfil_usuario_id": 2
}
```

### **PUT** `/api/usuarios/:id` - Actualizar usuario completo
**üí° Nota**: Si se actualiza la contrase√±a, se encripta autom√°ticamente con MD5.

### **üÜï PUT** `/api/usuarios/:id/estado` - Actualizar solo el estado del usuario
**Endpoint espec√≠fico** para cambiar √∫nicamente el estado sin afectar otros datos.

**Ejemplo Postman:**
```
PUT http://localhost:3001/api/usuarios/5/estado
```

**Body (JSON):**
```json
{
  "estado": "inactivo"  // Estados: activo, inactivo, suspendido, bloqueado
}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Estado del usuario actualizado exitosamente",
  "data": { /* usuario actualizado */ },
  "cambio": {
    "estado_anterior": "activo",
    "estado_nuevo": "inactivo"
  }
}
```

### **DELETE** `/api/usuarios/:id` - Eliminar usuario

---

## üîç **B√∫squedas de Usuarios - M√∫ltiples Opciones**

El sistema ofrece m√∫ltiples formas de encontrar usuarios:

```javascript
// Por ID espec√≠fico
GET /api/usuarios/1

// Por n√∫mero de documento
GET /api/usuarios/documento/12345678

// Por email espec√≠fico  
GET /api/usuarios/email/usuario@email.com

// B√∫squeda universal (email O documento)
GET /api/usuarios/buscar/usuario@email.com
GET /api/usuarios/buscar/12345678

// Obtener todos con filtros
GET /api/usuarios?estado=activo&perfil_usuario_id=2

// Obtener configuraci√≥n completa
GET /api/usuarios/config
```

---

## üÖøÔ∏è **CELDAS** - `/api/celdas` *(Funcionalidades Mejoradas)*

### **üÜï GET** `/api/celdas/config` - Obtener configuraci√≥n v√°lida
Endpoint para obtener tipos y estados permitidos para las celdas.

**Ejemplo Postman:**
```
GET http://localhost:3001/api/celdas/config
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Configuraci√≥n de celdas obtenida exitosamente",
  "data": {
    "types": {
      "allowed": ["Carro", "Moto", "otro"],
      "default": "Carro",
      "description": "Tipos de veh√≠culos permitidos en las celdas"
    },
    "states": {
      "allowed": ["Libre", "Ocupada", "Mantenimiento"],
      "default": "Libre",
      "description": "Estados posibles de las celdas de parqueo"
    },
    "validation": {
      "tipo": {
        "required": true,
        "type": "string",
        "enum": ["Carro", "Moto", "otro"]
      },
      "estado": {
        "required": false,
        "type": "string",
        "enum": ["Libre", "Ocupada", "Mantenimiento"],
        "default": "Libre"
      }
    }
  }
}
```

### **GET** `/api/celdas` - Obtener todas las celdas
**Query Parameters:** `page`, `limit`, `tipo`, `estado`

### **‚úÖ GET** `/api/celdas/:id` - Obtener celda por ID
*Funcionalidad corregida con mejor validaci√≥n y logging.*

### **GET** `/api/celdas/tipo/:tipo` - Obtener celdas por tipo
**Tipos v√°lidos:** `Carro`, `Moto`, `otro`

### **GET** `/api/celdas/estado/:estado` - Obtener celdas por estado
**Estados v√°lidos:** `Libre`, `Ocupada`, `Mantenimiento`

### **GET** `/api/celdas/disponibles/:tipo` - Obtener celdas disponibles por tipo

### **GET** `/api/celdas/estadisticas/:tipo` - Obtener estad√≠sticas por tipo

### **üÜï GET** `/api/celdas/debug/:id` - Debug de celda espec√≠fica
Endpoint para troubleshooting y verificaci√≥n directa en base de datos.

**Ejemplo Postman:**
```
GET http://localhost:3001/api/celdas/debug/1
```

**Respuesta:**
```json
{
  "success": true,
  "searchedId": "1",
  "sqlResult": [...],
  "found": true,
  "message": "Celda encontrada en base de datos"
}
```

### **POST** `/api/celdas` - Crear nueva celda
**‚úÖ Mejorado**: Con validaciones completas de tipos y estados.

**Body (JSON):**
```json
{
  "tipo": "Carro",    // Requerido: "Carro", "Moto", "otro"
  "estado": "Libre"   // Opcional: "Libre" (default), "Ocupada", "Mantenimiento"
}
```

**Respuesta (201):**
```json
{
  "success": true,
  "message": "Celda creada exitosamente",
  "data": {
    "id": 15,
    "tipo": "Carro",
    "estado": "Libre"
  }
}
```

### **‚úÖ PUT** `/api/celdas/:id` - Actualizar celda completa
**üÜï Mejorado**: Permite cambiar tipo y/o estado con validaciones robustas.

**Body (JSON) - Ambos campos opcionales:**
```json
{
  "tipo": "Moto",      // Opcional: "Carro", "Moto", "otro"
  "estado": "Ocupada"  // Opcional: "Libre", "Ocupada", "Mantenimiento"
}
```

**Respuesta (200):**
```json
{
  "success": true,
  "message": "Celda actualizada exitosamente",
  "data": {
    "previous": {
      "id": 1,
      "tipo": "Carro",
      "estado": "Libre"
    },
    "current": {
      "id": 1,
      "tipo": "Moto",
      "estado": "Ocupada"
    },
    "changes": {
      "tipo": {
        "from": "Carro",
        "to": "Moto"
      },
      "estado": {
        "from": "Libre",
        "to": "Ocupada"
      }
    }
  }
}
```

### **‚úÖ PATCH** `/api/celdas/:id/estado` - Cambiar solo el estado
**üÜï Mejorado**: Con validaciones y mejor logging.

**Body (JSON):**
```json
{
  "estado": "Mantenimiento"  // Requerido: "Libre", "Ocupada", "Mantenimiento"
}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Estado de celda actualizado exitosamente",
  "data": {
    "current": {
      "id": 1,
      "tipo": "Carro",
      "estado": "Mantenimiento"
    },
    "change": {
      "from": "Libre",
      "to": "Mantenimiento"
    }
  }
}
```

### **üÜï PATCH** `/api/celdas/:id/tipo` - Cambiar solo el tipo
**Nuevo endpoint** para cambiar √∫nicamente el tipo de celda.

**Ejemplo Postman:**
```
PATCH http://localhost:3001/api/celdas/1/tipo
```

**Body (JSON):**
```json
{
  "tipo": "Moto"  // Requerido: "Carro", "Moto", "otro"
}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Tipo de celda actualizado exitosamente",
  "data": {
    "current": {
      "id": 1,
      "tipo": "Moto",
      "estado": "Libre"
    },
    "change": {
      "from": "Carro",
      "to": "Moto"
    }
  }
}
```

### **‚úÖ DELETE** `/api/celdas/:id` - Eliminar celda
**üîß Corregido**: Solucionados problemas de b√∫squeda y eliminaci√≥n.

**Respuesta (200):**
```json
{
  "success": true,
  "message": "Celda eliminada exitosamente",
  "data": {
    "deletedCellId": "1"
  }
}
```

---

## üöó **VEH√çCULOS** - `/api/vehiculos`

### **GET** `/api/vehiculos` - Obtener todos los veh√≠culos
**Query Parameters:** `page`, `limit`, `tipo`, `usuario_id`

### **GET** `/api/vehiculos/:id` - Obtener veh√≠culo por ID

### **GET** `/api/vehiculos/placa/:placa` - Obtener veh√≠culo por placa

### **GET** `/api/vehiculos/usuario/:usuario_id` - Obtener veh√≠culos por usuario

### **POST** `/api/vehiculos` - Crear nuevo veh√≠culo

### **PUT** `/api/vehiculos/:id` - Actualizar veh√≠culo

### **DELETE** `/api/vehiculos/:id` - Eliminar veh√≠culo

---

## üö™ **ACCESOS/SALIDAS** - `/api/accesos-salidas` *(Con C√°lculo Autom√°tico de Tiempo)*

### **üÜï GET** `/api/accesos-salidas/config` - Obtener configuraci√≥n de accesos-salidas
Endpoint para obtener la configuraci√≥n completa del m√≥dulo incluyendo informaci√≥n sobre el c√°lculo autom√°tico.

**Ejemplo Postman:**
```
GET http://localhost:3001/api/accesos-salidas/config
```

**Respuesta:**
```json
{
  "success": true,
  "data": {
    "movimientos": {
      "allowed": ["Entrada", "Salida"],
      "description": "Tipos de movimiento permitidos en el sistema"
    },
    "funcionalidades": {
      "calculo_automatico": {
        "descripcion": "Para movimiento 'Salida', el tiempo_estadia se calcula autom√°ticamente",
        "formula": "fecha_hora_salida - fecha_hora_ultima_entrada (en segundos)",
        "validaciones": [
          "El veh√≠culo debe tener un registro de entrada previo",
          "No se permite registrar salida sin entrada",
          "No se permite registrar entrada si ya existe una entrada activa"
        ]
      }
    },
    "campos": { /* validaciones completas */ },
    "respuestas_especiales": {
      "codigos_error": {
        "ENTRADA_DUPLICADA": "El veh√≠culo ya tiene una entrada activa",
        "SIN_ENTRADA_PREVIA": "No se puede registrar salida sin entrada previa"
      }
    }
  }
}
```

### **GET** `/api/accesos-salidas` - Obtener todos los registros
**Query Parameters:** `page`, `limit`, `movimiento`, `vehiculo_id`

### **GET** `/api/accesos-salidas/:id` - Obtener registro por ID

### **üÜï GET** `/api/accesos-salidas/estado-vehiculo/:vehiculo_id` - Estado actual del veh√≠culo
**Endpoint inteligente** para consultar si un veh√≠culo est√° dentro o fuera del parqueadero.

**Ejemplo Postman:**
```
GET http://localhost:3001/api/accesos-salidas/estado-vehiculo/30
```

**Respuesta - Veh√≠culo DENTRO:**
```json
{
  "success": true,
  "data": {
    "vehiculo_id": 30,
    "estado": "DENTRO",
    "descripcion": "El veh√≠culo est√° actualmente dentro del parqueadero",
    "ultima_entrada": {
      "id_registro": 101,
      "fecha_hora": "2024-01-15T10:00:00.000Z",
      "puerta": "Principal",
      "tiempo_transcurrido_segundos": 3600,
      "tiempo_transcurrido_minutos": 60,
      "tiempo_transcurrido_horas": 1
    },
    "historial_reciente": [...]
  }
}
```

**Respuesta - Veh√≠culo FUERA:**
```json
{
  "success": true,
  "data": {
    "vehiculo_id": 30,
    "estado": "FUERA",
    "descripcion": "El veh√≠culo no est√° en el parqueadero o ya registr√≥ su salida",
    "historial_reciente": [...]
  }
}
```

### **‚≠ê POST** `/api/accesos-salidas` - Crear registro con c√°lculo autom√°tico
**üöÄ FUNCIONALIDAD PRINCIPAL**: Para movimiento "Salida", calcula autom√°ticamente el tiempo de estad√≠a.

#### **üìã Funcionamiento:**

**Para ENTRADAS:**
```json
{
  "movimiento": "Entrada",
  "vehiculo_id": 30,
  "puerta": "Principal"
  // tiempo_estadia es opcional para entradas
}
```

**Para SALIDAS (‚è±Ô∏è C√°lculo Autom√°tico):**
```json
{
  "movimiento": "Salida",
  "vehiculo_id": 30,
  "puerta": "Principal"
  // ‚ö†Ô∏è tiempo_estadia se IGNORA y se calcula autom√°ticamente
}
```

#### **‚úÖ Respuesta de ENTRADA:**
```json
{
  "success": true,
  "message": "Registro de entrada creado exitosamente",
  "data": {
    "id": 101,
    "movimiento": "Entrada",
    "fecha_hora": "2024-01-15T10:00:00.000Z",
    "puerta": "Principal",
    "tiempo_estadia": null,
    "vehiculo_id": 30
  }
}
```

#### **‚≠ê Respuesta de SALIDA (con tiempo calculado):**
```json
{
  "success": true,
  "message": "Registro de salida creado exitosamente. Tiempo de estad√≠a: 7200 segundos",
  "data": {
    "id": 102,
    "movimiento": "Salida",
    "fecha_hora": "2024-01-15T12:00:00.000Z",
    "puerta": "Principal",
    "tiempo_estadia": 7200,  // ‚≠ê CALCULADO AUTOM√ÅTICAMENTE
    "vehiculo_id": 30
  },
  "tiempo_calculado": {
    "tiempo_estadia_segundos": 7200,
    "tiempo_estadia_minutos": 120,
    "tiempo_estadia_horas": 2
  }
}
```

#### **‚ùå Validaciones y Errores:**

**Entrada Duplicada:**
```json
{
  "success": false,
  "error": "El veh√≠culo 30 ya tiene un registro de entrada activo. Debe registrar la salida antes de una nueva entrada.",
  "codigo": "ENTRADA_DUPLICADA"
}
```

**Salida Sin Entrada:**
```json
{
  "success": false,
  "error": "El veh√≠culo 30 no tiene un registro de entrada activo. No se puede registrar la salida.",
  "codigo": "SIN_ENTRADA_PREVIA"
}
```

**Fecha Inv√°lida:**
```json
{
  "success": false,
  "error": "La fecha/hora de salida no puede ser anterior a la fecha/hora de entrada"
}
```

### **PUT** `/api/accesos-salidas/:id` - Actualizar registro

### **DELETE** `/api/accesos-salidas/:id` - Eliminar registro

---

## ‚è±Ô∏è **Flujo de Trabajo de Accesos-Salidas**

### **Secuencia Normal:**
```javascript
// 1. Consultar estado del veh√≠culo
GET /api/accesos-salidas/estado-vehiculo/30
// Respuesta: { estado: "FUERA" }

// 2. Registrar entrada
POST /api/accesos-salidas
{
  "movimiento": "Entrada",
  "vehiculo_id": 30
}

// 3. Consultar estado nuevamente
GET /api/accesos-salidas/estado-vehiculo/30
// Respuesta: { estado: "DENTRO", tiempo_transcurrido_minutos: 45 }

// 4. Registrar salida (‚≠ê tiempo calculado autom√°ticamente)
POST /api/accesos-salidas
{
  "movimiento": "Salida",
  "vehiculo_id": 30
}
// Respuesta incluye tiempo_calculado autom√°ticamente
```

### **üõ°Ô∏è Sistema de Validaciones:**
- ‚úÖ **Previene entradas duplicadas** - No permite nueva entrada si el veh√≠culo est√° dentro
- ‚úÖ **Requiere entrada previa** - No permite salida sin registro de entrada
- ‚úÖ **C√°lculo preciso** - Diferencia exacta en segundos entre entrada y salida  
- ‚úÖ **Validaci√≥n temporal** - Salida no puede ser anterior a entrada
- ‚úÖ **Estado coherente** - Mantiene integridad del sistema de parqueadero

---

## üìä **HISTORIAL PARQUEO** - `/api/historial-parqueo`

### **GET** `/api/historial-parqueo` - Obtener todo el historial

### **GET** `/api/historial-parqueo/vehiculo/:vehiculo_id` - Por veh√≠culo

### **GET** `/api/historial-parqueo/celda/:celda_id` - Por celda

### **GET** `/api/historial-parqueo/estadisticas` - Estad√≠sticas generales

### **POST** `/api/historial-parqueo` - Crear registro

---

## üö® **INCIDENCIAS** - `/api/incidencias`

### **GET** `/api/incidencias` - Obtener todas las incidencias

### **GET** `/api/incidencias/:id` - Obtener incidencia por ID

### **POST** `/api/incidencias` - Crear nueva incidencia

### **PUT** `/api/incidencias/:id` - Actualizar incidencia

### **DELETE** `/api/incidencias/:id` - Eliminar incidencia

---

## üìã **REPORTES DE INCIDENCIA** - `/api/reportes-incidencia`

### **GET** `/api/reportes-incidencia` - Obtener todos los reportes

### **GET** `/api/reportes-incidencia/vehiculo/:vehiculo_id` - Por veh√≠culo

### **GET** `/api/reportes-incidencia/incidencia/:incidencia_id` - Por incidencia

### **POST** `/api/reportes-incidencia` - Crear reporte

---

## üö¶ **PICO Y PLACA** - `/api/pico-placa`

### **GET** `/api/pico-placa` - Obtener todas las reglas

### **GET** `/api/pico-placa/:id` - Obtener regla por ID

### **GET** `/api/pico-placa/tipo/:tipo/dia/:dia` - Por tipo y d√≠a

### **POST** `/api/pico-placa` - Crear nueva regla

### **PUT** `/api/pico-placa/:id` - Actualizar regla

### **DELETE** `/api/pico-placa/:id` - Eliminar regla

---

## üë§ **PERFILES DE USUARIO** - `/api/perfiles-usuario`

### **GET** `/api/perfiles-usuario` - Obtener todos los perfiles

### **GET** `/api/perfiles-usuario/:id` - Obtener perfil por ID

### **POST** `/api/perfiles-usuario` - Crear nuevo perfil

### **PUT** `/api/perfiles-usuario/:id` - Actualizar perfil

### **DELETE** `/api/perfiles-usuario/:id` - Eliminar perfil

---

## üè• **HEALTH CHECK** - `/health`

### **GET** `/health` - Verificar estado del servidor
**Ejemplo Postman:**
```
GET http://localhost:3001/health
```

**Respuesta:**
```json
{
  "status": "OK",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "service": "parking-management-api"
}
```

---

## üåê **CORS y Frontend Integration**

### **‚úÖ CORS Optimizado**
El servidor est√° configurado para permitir acceso desde:

- **‚úÖ Cualquier dominio/puerto** (desarrollo y producci√≥n)
- **‚úÖ localhost:5175** (Vite dev server)
- **‚úÖ localhost:5174** (Vite dev server alternativo)
- **‚úÖ localhost:3000** (React dev server)
- **‚úÖ localhost:3001** (Backend)
- **‚úÖ Todos los m√©todos HTTP** (GET, POST, PUT, DELETE, PATCH, OPTIONS)
- **‚úÖ Headers personalizados** (Authorization, X-Requested-With, etc.)

### **Configuraci√≥n para Frontend**

**React/Vue/Angular:**
```javascript
// Configuraci√≥n base para fetch
const API_BASE = 'http://localhost:3001';

// Ejemplo de uso con fetch
const response = await fetch(`${API_BASE}/api/usuarios/login`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    direccion_correo: 'user@example.com',
    clave: 'password123'
  })
});

const data = await response.json();
```

**Axios:**
```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:3001',
  timeout: 5000,
});

// Login example
const loginUser = async (email, password) => {
  try {
    const response = await api.post('/api/usuarios/login', {
      direccion_correo: email,
      clave: password
    });
    return response.data;
  } catch (error) {
    console.error('Login error:', error.response.data);
    throw error;
  }
};
```

---

## üìù **C√≥digos de Respuesta HTTP**

- **200**: OK - Operaci√≥n exitosa
- **201**: Created - Recurso creado exitosamente
- **400**: Bad Request - Datos de entrada inv√°lidos o faltantes
- **401**: Unauthorized - Credenciales inv√°lidas o usuario inactivo
- **404**: Not Found - Recurso no encontrado
- **409**: Conflict - Conflicto (ej: documento duplicado)
- **500**: Internal Server Error - Error del servidor

## üìä **Estructura de Respuestas**

### **Respuesta Exitosa:**
```json
{
  "success": true,
  "message": "Operaci√≥n exitosa",
  "data": {
    // Datos de respuesta
  }
}
```

### **Respuesta de Error:**
```json
{
  "success": false,
  "error": "Mensaje de error descriptivo"
}
```

## üîß **Validaciones de Datos**

### **Celdas:**
- **Tipos permitidos**: `"Carro"`, `"Moto"`, `"otro"`
- **Estados permitidos**: `"Libre"`, `"Ocupada"`, `"Mantenimiento"`

### **Usuarios:**
- **Tipos de documento**: `"CC"`, `"TI"`, `"CE"`, etc.
- **Estados**: `"activo"`, `"inactivo"`
- **Contrase√±as**: Encriptaci√≥n autom√°tica MD5

### **Veh√≠culos:**
- **Tipos**: `"Carro"`, `"Moto"`, `"Bicicleta"`, etc.
- **Placas**: Formato validado

## üìà **Sistema de Logging**

El sistema incluye logging detallado para debugging:

```bash
# Logs de ejemplo en consola del servidor
[GET CELL] Buscando celda con ID: 1
[GET CELL] Resultado de b√∫squeda: Encontrada
[UPDATE CELL] Actualizando celda con ID: 1
[UPDATE CELL] Datos recibidos: { tipo: "Moto", estado: "Ocupada" }
[DELETE CELL] Intentando eliminar celda con ID: 1
[CREATE CELL] Creando nueva celda: { tipo: "Carro", estado: "Libre" }
```

## üß™ Testing

```bash
# Ejecutar todas las pruebas
npm test

# Ejecutar pruebas espec√≠ficas
npm run test:usuario

# Ejecutar con informaci√≥n detallada
npm run test:verbose

# Guardar resultados en archivo
npm run test:save
```

## üöÄ Despliegue

### Variables de Entorno

| Variable | Descripci√≥n | Valor por defecto |
|----------|-------------|-------------------|
| `NODE_ENV` | Entorno de ejecuci√≥n | `development` |
| `PORT` | Puerto del servidor | `3001` |
| `DB_HOST` | Host de la base de datos | `localhost` |
| `DB_PORT` | Puerto de la base de datos | `3306` |
| `DB_USER` | Usuario de la base de datos | `root` |
| `DB_PASSWORD` | Contrase√±a de la base de datos | |
| `DB_NAME` | Nombre de la base de datos | `ParkingLot` |

### Vercel

```bash
npm i -g vercel
vercel env add DB_HOST
vercel env add DB_USER
vercel env add DB_PASSWORD
vercel env add DB_NAME
vercel --prod
```

### Render

1. Conectar repositorio en [render.com](https://render.com)
2. Configurar variables de entorno en el dashboard
3. El archivo `render.yaml` ya est√° configurado

## üîÑ **Changelog Reciente**

### **v3.0.0** - Latest *(Actualizaci√≥n Mayor)*
- ‚≠ê **C√°lculo autom√°tico de tiempo de estad√≠a** - Para movimiento "Salida" en accesos-salidas
- üö™ **Control inteligente de accesos** - Validaciones entrada/salida con estado coherente
- üìç **Estado en tiempo real de veh√≠culos** - Endpoint para consultar si est√° dentro/fuera del parqueadero
- üîç **Sistema de b√∫squeda expandido** - 11 endpoints de usuarios con m√∫ltiples opciones de b√∫squeda
- üë• **Gesti√≥n completa de usuarios**:
  - `GET /api/usuarios/email/:email` - B√∫squeda por email
  - `GET /api/usuarios/buscar/:identifier` - B√∫squeda universal (email o documento)
  - `PUT /api/usuarios/:id/estado` - Actualizaci√≥n espec√≠fica de estado
  - `GET /api/usuarios/config` - Configuraci√≥n completa del m√≥dulo
- üöó **Endpoints de accesos-salidas mejorados**:
  - `GET /api/accesos-salidas/estado-vehiculo/:id` - Estado actual del veh√≠culo
  - `GET /api/accesos-salidas/config` - Configuraci√≥n con funcionalidades autom√°ticas
- üõ°Ô∏è **Validaciones robustas mejoradas**:
  - Prevenci√≥n de entradas duplicadas
  - Validaci√≥n de salidas sin entrada previa
  - Estados de usuario expandidos (activo, inactivo, suspendido, bloqueado)
- ‚è±Ô∏è **C√°lculo autom√°tico de tiempo**:
  - Diferencia exacta en segundos entre entrada y salida
  - Conversi√≥n autom√°tica a minutos y horas
  - Validaci√≥n temporal (salida no anterior a entrada)
- üìù **Logging mejorado** con trazabilidad completa de operaciones
- üìä **Documentaci√≥n expandida** con ejemplos detallados y casos de uso

### **v2.0.0** - Previous
- ‚úÖ **CORS optimizado** para acceso desde cualquier dominio/puerto
- üîê **Autenticaci√≥n MD5** implementada con endpoint `/api/usuarios/login`
- üîß **Funcionalidad de celdas corregida** y mejorada completamente
- üÜï **Nuevos endpoints**: `/config`, `/debug/:id`, `/:id/tipo`
- ‚úÖ **Validaciones robustas** para tipos y estados de celdas
- üìù **Sistema de logging** para debugging y monitoreo
- üéØ **Respuestas mejoradas** con historial de cambios
- üìö **Documentaci√≥n completa** actualizada

## ü§ù Contribuci√≥n

1. Fork el repositorio
2. Crear rama feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit cambios (`git commit -am 'Agregar nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Crear Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT.

## üë• Autores

- **SENA - Grupo Huber Andres** - Desarrollo inicial y mejoras

## üÜò Soporte

Para reportar bugs o solicitar funcionalidades, crear un [issue](https://github.com/mauriciorivero/ParkingSENABend/issues) en GitHub.

---

## üìû **Contacto y Desarrollo**

- **Repositorio**: https://github.com/mauriciorivero/ParkingSENABend
- **Documentaci√≥n API**: http://localhost:3001/
- **Health Check**: http://localhost:3001/health
- **Versi√≥n Actual**: v3.0.0 (Actualizaci√≥n Mayor)

### **üåü Funcionalidades Destacadas v3.0.0**

- **‚è±Ô∏è C√°lculo autom√°tico de tiempo de estad√≠a** para control preciso de parqueadero
- **üîç Sistema de b√∫squeda universal** de usuarios (email, documento, identificador)
- **üìç Consulta de estado en tiempo real** de veh√≠culos (dentro/fuera)
- **üõ°Ô∏è Validaciones inteligentes** que previenen inconsistencias de datos
- **üìä Endpoints de configuraci√≥n** para integraci√≥n din√°mica con frontend

### **üéØ Endpoints Clave para Frontend**

```javascript
// Sistema de login
POST /api/usuarios/login

// B√∫squeda flexible de usuarios  
GET /api/usuarios/buscar/:identifier

// Control de accesos con c√°lculo autom√°tico
POST /api/accesos-salidas

// Estado en tiempo real de veh√≠culos
GET /api/accesos-salidas/estado-vehiculo/:vehiculo_id

// Configuraciones din√°micas
GET /api/usuarios/config
GET /api/accesos-salidas/config
GET /api/celdas/config
```

**¬°API v3.0.0 completamente funcional y lista para integraci√≥n con cualquier frontend moderno!** üöÄ‚≠ê